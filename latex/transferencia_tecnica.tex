\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[spanish]{babel}
\usepackage{geometry}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{fancyhdr}
\usepackage{tcolorbox}

\geometry{a4paper, margin=2.5cm}
\pagestyle{fancy}
\fancyhf{}
\rhead{EGESUR - Asistente Normativo}
\lhead{Documento de Transferencia TÃ©cnica}
\rfoot{\thepage}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,
    breaklines=true,
    captionpos=b,
    keepspaces=true,
    numbers=left,
    numbersep=5pt,
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    tabsize=2
}
\lstset{style=mystyle}

\title{\textbf{Documento de Transferencia TÃ©cnica}\\
\large API de Normativas EGESUR\\
\small Asistente Normativo con BÃºsqueda SemÃ¡ntica}
\author{ConsultorÃ­a de Desarrollo\\EGESUR - Empresa de GeneraciÃ³n ElÃ©ctrica del Sur S.A.}
\date{\today}

\begin{document}

\maketitle
\thispagestyle{empty}

\begin{abstract}
Este documento describe la arquitectura, configuraciÃ³n y operaciÃ³n del sistema de API REST para consulta de normativas de EGESUR. El sistema utiliza bÃºsqueda semÃ¡ntica con embeddings de OpenAI para localizar informaciÃ³n relevante en documentos PDF almacenados en Google Drive, diseÃ±ado para integraciÃ³n con ChatGPT Custom Actions.
\end{abstract}

\newpage
\tableofcontents
\newpage

\section{Resumen Ejecutivo}

\subsection{PropÃ³sito del Sistema}
El \textbf{Asistente Normativo EGESUR} es una API REST desarrollada con FastAPI que permite realizar bÃºsquedas semÃ¡nticas sobre documentos normativos (PDF, DOCX, Google Docs) almacenados en Google Drive. El sistema:

\begin{itemize}
    \item Extrae texto automÃ¡ticamente de documentos
    \item Genera embeddings vectoriales usando OpenAI API
    \item Realiza bÃºsquedas semÃ¡nticas por similitud de coseno
    \item Persiste embeddings en PostgreSQL para optimizar tiempos de respuesta
    \item Se integra con ChatGPT como Custom Action
\end{itemize}

\subsection{TecnologÃ­as Principales}
\begin{itemize}
    \item \textbf{Framework:} FastAPI (Python 3.12)
    \item \textbf{Base de Datos:} PostgreSQL (persistencia de embeddings)
    \item \textbf{Almacenamiento:} Google Drive API
    \item \textbf{IA:} OpenAI text-embedding-3-small
    \item \textbf{Despliegue:} Railway/Render (PaaS)
\end{itemize}

\section{Arquitectura del Sistema}

\subsection{Componentes Principales}

\begin{tcolorbox}[colback=blue!5!white,colframe=blue!75!black,title=Diagrama de Arquitectura]
\begin{verbatim}
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ChatGPT   â”‚â”€â”€â”€â”€â”€â”€>â”‚   FastAPI    â”‚â”€â”€â”€â”€â”€â”€>â”‚ Google Drive â”‚
â”‚   Custom    â”‚       â”‚   (main.py)  â”‚       â”‚  (PDFs/DOCX) â”‚
â”‚   Action    â”‚<â”€â”€â”€â”€â”€â”€â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚    â”‚
                            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚                â”‚   OpenAI     â”‚
                            â”‚                â”‚  Embeddings  â”‚
                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
                            â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            v
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚  PostgreSQL  â”‚
                      â”‚  (document_  â”‚
                      â”‚   chunks)    â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\end{verbatim}
\end{tcolorbox}

\subsection{Flujo de Datos}

\subsubsection{Primera EjecuciÃ³n (Precalentamiento)}
\begin{enumerate}
    \item Llamada a \texttt{/api/warmup}
    \item Descarga todos los PDFs de Google Drive
    \item Extrae texto con PyPDF2 y python-docx
    \item Divide en chunks de ~3000 caracteres
    \item Genera embeddings con OpenAI (1536 dimensiones)
    \item Guarda en PostgreSQL + cachÃ© en memoria
    \item \textbf{Tiempo:} 10-15 minutos (solo primera vez)
\end{enumerate}

\subsubsection{BÃºsqueda de Usuario}
\begin{enumerate}
    \item Consulta a \texttt{/api/buscarNormativa?termino=emergencia}
    \item Genera embedding del tÃ©rmino de bÃºsqueda
    \item Calcula similitud de coseno con chunks en cachÃ©
    \item Retorna top 10 chunks mÃ¡s relevantes
    \item \textbf{Tiempo:} < 10 segundos
\end{enumerate}

\subsubsection{Reinicio del Servicio}
\begin{enumerate}
    \item Evento \texttt{startup} carga chunks desde PostgreSQL
    \item Pobla cachÃ© en memoria
    \item Servicio listo
    \item \textbf{Tiempo:} 2-5 segundos
\end{enumerate}

\section{ConfiguraciÃ³n y Despliegue}

\subsection{Variables de Entorno}

Configurar las siguientes variables en la plataforma de despliegue:

\begin{lstlisting}[language=bash, caption=Variables de entorno requeridas]
# Google Drive
FOLDER_ID=<ID_carpeta_Google_Drive>
GOOGLE_CREDENTIALS_BASE64=<credenciales_service_account_base64>

# OpenAI
OPENAI_API_KEY=sk-proj-...

# PostgreSQL
DATABASE_URL=postgresql://user:pass@host:5432/database

# Opcional para desarrollo local
GOOGLE_APPLICATION_CREDENTIALS=credenciales.json
\end{lstlisting}

\subsection{Despliegue en Railway/Render}

\subsubsection{Paso 1: Crear Servicio Web}
\begin{enumerate}
    \item Conectar repositorio GitHub
    \item Configurar build command: \texttt{pip install -r requirements.txt}
    \item Configurar start command: \texttt{uvicorn src.main:app --host 0.0.0.0 --port \$PORT}
    \item Python version: 3.12.3 (ver \texttt{runtime.txt})
\end{enumerate}

\subsubsection{Paso 2: Crear PostgreSQL}
\begin{enumerate}
    \item Crear base de datos PostgreSQL (plan gratuito: 256 MB)
    \item Copiar Internal Database URL
    \item Agregar como variable de entorno \texttt{DATABASE_URL}
\end{enumerate}

\subsubsection{Paso 3: Configurar Credenciales}
\begin{enumerate}
    \item Google Service Account: Codificar JSON en base64
    \begin{lstlisting}[language=bash]
base64 -w 0 credenciales.json
    \end{lstlisting}
    \item Agregar como \texttt{GOOGLE\_CREDENTIALS\_BASE64}
    \item OpenAI: Obtener API key de \url{https://platform.openai.com}
\end{enumerate}

\subsubsection{Paso 4: Primera EjecuciÃ³n}
\begin{lstlisting}[language=bash]
# Precalentar cache (solo una vez)
curl -X GET "https://tu-servicio.onrender.com/api/warmup"

# Verificar estado
curl "https://tu-servicio.onrender.com/api/debug/cache-status"
\end{lstlisting}

\section{OperaciÃ³n y Mantenimiento}

\subsection{Endpoints Principales}

\begin{table}[h]
\centering
\begin{tabular}{|l|l|p{6cm}|}
\hline
\textbf{Endpoint} & \textbf{MÃ©todo} & \textbf{PropÃ³sito} \\
\hline
\texttt{/api/buscarNormativa} & GET & BÃºsqueda semÃ¡ntica (termino opcional) \\
\texttt{/api/warmup} & GET & Precargar todos los documentos \\
\texttt{/api/refresh-cache} & POST & Actualizar cachÃ© tras cambios en Drive \\
\texttt{/ping} & GET & Health check para uptime monitoring \\
\texttt{/api/debug/env} & GET & Verificar configuraciÃ³n de variables \\
\texttt{/api/debug/cache-status} & GET & Estado del cachÃ© \\
\hline
\end{tabular}
\caption{Endpoints de la API}
\end{table}

\subsection{Tareas de Mantenimiento}

\subsubsection{Actualizar Documentos en Google Drive}
\begin{enumerate}
    \item Subir/modificar archivos en carpeta de Google Drive
    \item Ejecutar \texttt{POST /api/refresh-cache}
    \item Esperar 10-15 minutos (regeneraciÃ³n de embeddings)
    \item Verificar: \texttt{GET /api/debug/cache-status}
\end{enumerate}

\subsubsection{Monitoreo de Logs}
Patrones importantes en logs:
\begin{itemize}
    \item \texttt{âœ“} = Operaciones exitosas
    \item \texttt{âš ï¸} = Advertencias (funcionalidad degradada)
    \item \texttt{âœ—} = Errores crÃ­ticos
    \item \texttt{ğŸ”¥} = Operaciones de cachÃ© warmup
    \item \texttt{âš¡} = BÃºsquedas desde cachÃ© (rÃ¡pidas)
\end{itemize}

\subsubsection{RotaciÃ³n de Credenciales}
\textbf{Frecuencia recomendada:} Cada 90 dÃ­as

\begin{enumerate}
    \item \textbf{OpenAI API Key:}
    \begin{itemize}
        \item Generar nueva key en \url{https://platform.openai.com}
        \item Actualizar variable \texttt{OPENAI\_API\_KEY}
        \item Revocar key antigua
    \end{itemize}
    \item \textbf{Google Service Account:}
    \begin{itemize}
        \item Crear nuevo service account en Google Cloud Console
        \item Dar permisos de lectura a carpeta de Drive
        \item Codificar nuevo JSON en base64
        \item Actualizar \texttt{GOOGLE\_CREDENTIALS\_BASE64}
        \item Deshabilitar service account antigua
    \end{itemize}
    \item \textbf{PostgreSQL:}
    \begin{itemize}
        \item Cambiar contraseÃ±a en dashboard de Railway/Render
        \item Actualizar \texttt{DATABASE\_URL} automÃ¡ticamente
    \end{itemize}
\end{enumerate}

\section{SoluciÃ³n de Problemas}

\subsection{Problemas Comunes}

\begin{table}[h]
\centering
\small
\begin{tabular}{|p{4cm}|p{4cm}|p{5cm}|}
\hline
\textbf{SÃ­ntoma} & \textbf{Causa} & \textbf{SoluciÃ³n} \\
\hline
Timeout en bÃºsqueda & CachÃ© vacÃ­o & Ejecutar \texttt{/api/warmup} \\
\hline
Error OpenAI & API key invÃ¡lida & Verificar \texttt{OPENAI\_API\_KEY} \\
\hline
Sin resultados & TÃ©rmino muy especÃ­fico & Usar tÃ©rminos mÃ¡s generales \\
\hline
Error PostgreSQL & DATABASE\_URL incorrecta & Copiar Internal Database URL \\
\hline
Error Google Drive & Credenciales expiradas & Rotar service account \\
\hline
\end{tabular}
\caption{Troubleshooting}
\end{table}

\subsection{Comandos de DiagnÃ³stico}

\begin{lstlisting}[language=bash, caption=VerificaciÃ³n de estado del sistema]
# Verificar que el servicio responde
curl https://tu-servicio.onrender.com/

# Verificar variables de entorno
curl https://tu-servicio.onrender.com/api/debug/env

# Verificar cache
curl https://tu-servicio.onrender.com/api/debug/cache-status

# Verificar OpenAI
curl https://tu-servicio.onrender.com/api/debug/test-openai

# Verificar Google Drive
curl https://tu-servicio.onrender.com/api/debug/test-drive
\end{lstlisting}

\section{Estructura del Repositorio}

\begin{lstlisting}[caption=OrganizaciÃ³n de archivos]
EGESUR-AsistenteNormativo/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.py              # API principal (1238 lineas)
â”‚   â””â”€â”€ test_openai.py       # Test de conectividad OpenAI
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ README.md            # Documentacion general
â”‚   â”œâ”€â”€ CLAUDE.md            # Guia para Claude Code
â”‚   â””â”€â”€ POSTGRESQL_SETUP.md  # Setup de base de datos
â”œâ”€â”€ gpt/
â”‚   â”œâ”€â”€ PROMPT_OPTIMIZADO.md # Prompt del GPT personalizado
â”‚   â””â”€â”€ SCHEMA_OPENAPI.md    # Schema para Custom Actions
â”œâ”€â”€ latex/
â”‚   â””â”€â”€ transferencia_tecnica.tex  # Este documento
â”œâ”€â”€ .env.example             # Template de variables
â”œâ”€â”€ .gitignore               # Exclusiones de git
â”œâ”€â”€ requirements.txt         # Dependencias Python
â””â”€â”€ runtime.txt              # Version de Python
\end{lstlisting}

\section{Contacto y Recursos}

\subsection{DocumentaciÃ³n}
\begin{itemize}
    \item \textbf{README.md:} DocumentaciÃ³n general del proyecto
    \item \textbf{POSTGRESQL\_SETUP.md:} GuÃ­a paso a paso de configuraciÃ³n de PostgreSQL
    \item \textbf{CLAUDE.md:} GuÃ­a para desarrolladores (Claude Code)
\end{itemize}

\subsection{URLs de Referencia}
\begin{itemize}
    \item Railway: \url{https://railway.app}
    \item Render: \url{https://render.com}
    \item OpenAI Platform: \url{https://platform.openai.com}
    \item Google Cloud Console: \url{https://console.cloud.google.com}
\end{itemize}

\subsection{Requisitos de Capacidad}

\begin{table}[h]
\centering
\begin{tabular}{|l|l|}
\hline
\textbf{Recurso} & \textbf{RecomendaciÃ³n} \\
\hline
PostgreSQL Storage & 256 MB (plan gratuito suficiente para ~70 PDFs) \\
RAM & 512 MB mÃ­nimo \\
CPU & 1 vCPU \\
Ancho de banda & Ilimitado (plan Railway/Render gratuito) \\
\hline
\end{tabular}
\caption{Requisitos de recursos}
\end{table}

\section{ConclusiÃ³n}

El sistema \textbf{Asistente Normativo EGESUR} estÃ¡ en producciÃ³n y listo para transferencia al equipo de TI. La arquitectura de cachÃ© dual (memoria + PostgreSQL) garantiza tiempos de respuesta Ã³ptimos (<10 segundos) incluso tras reinicios del servicio.

\subsection{PrÃ³ximos Pasos Recomendados}
\begin{enumerate}
    \item Configurar monitoreo de uptime (ej: UptimeRobot)
    \item Implementar rate limiting para proteger contra abuso
    \item Restringir CORS a dominios especÃ­ficos en producciÃ³n
    \item Documentar procedimientos operativos internos
    \item Capacitar al equipo de TI en operaciÃ³n bÃ¡sica
\end{enumerate}

\vspace{1cm}
\begin{center}
\textit{Documento generado automÃ¡ticamente}\\
\textit{VersiÃ³n 1.0 - \today}
\end{center}

\end{document}